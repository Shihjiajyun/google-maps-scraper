import requests
import time
import csv
import os
import re
from dotenv import load_dotenv

# âœ… 1. å¾ç’°å¢ƒè®Šæ•¸è®€å– API é‡‘é‘°
try:
    load_dotenv()
    API_KEY = os.getenv('API_KEY')
except UnicodeDecodeError:
    print("âŒ .env æª”æ¡ˆç·¨ç¢¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æª”æ¡ˆä½¿ç”¨ UTF-8 ç·¨ç¢¼")
    print("ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š")
    print("   1. åˆªé™¤ç¾æœ‰çš„ .env æª”æ¡ˆ")
    print("   2. å»ºç«‹æ–°çš„ .env æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š")
    print("   API_KEY=æ‚¨çš„Google_Places_API_Key")
    print("   3. ç¢ºä¿æª”æ¡ˆä¿å­˜ç‚º UTF-8 ç·¨ç¢¼")
    exit(1)
except Exception as e:
    print(f"âŒ è¼‰å…¥ .env æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
    exit(1)

if not API_KEY:
    print("âŒ æœªæ‰¾åˆ° API_KEY")
    print("ğŸ’¡ è«‹å»ºç«‹ .env æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š")
    print("API_KEY=æ‚¨çš„Google_Places_API_Key")
    
    # å˜—è©¦å»ºç«‹ .env æª”æ¡ˆæ¨¡æ¿
    try:
        with open('.env', 'w', encoding='utf-8') as f:
            f.write('# Google Places API é‡‘é‘°\n')
            f.write('# è«‹å°‡ä¸‹é¢çš„ YOUR_API_KEY_HERE æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› API é‡‘é‘°\n')
            f.write('API_KEY=YOUR_API_KEY_HERE\n')
        print("âœ… å·²å»ºç«‹ .env æª”æ¡ˆæ¨¡æ¿ï¼Œè«‹ç·¨è¼¯ä¸¦å¡«å…¥æ‚¨çš„ API é‡‘é‘°")
    except Exception as e:
        print(f"âŒ ç„¡æ³•å»ºç«‹ .env æª”æ¡ˆï¼š{e}")
    
    exit(1)

print(f"âœ… API é‡‘é‘°è¼‰å…¥æˆåŠŸï¼š{API_KEY[:10]}...")

# âœ… 2. å°ç£å…­éƒ½ + å±æ±æ‰€æœ‰è¡Œæ”¿å€ä¸­å¿ƒåº§æ¨™
area_keywords = [
    # å°åŒ—å¸‚ (12å€)
    ("ä¸­æ­£å€", "25.0330,121.5183", "å°åŒ—å¸‚"),
    ("å¤§åŒå€", "25.0633,121.5130", "å°åŒ—å¸‚"),
    ("ä¸­å±±å€", "25.0636,121.5264", "å°åŒ—å¸‚"),
    ("æ¾å±±å€", "25.0576,121.5776", "å°åŒ—å¸‚"),
    ("å¤§å®‰å€", "25.0267,121.5436", "å°åŒ—å¸‚"),
    ("è¬è¯å€", "25.0374,121.4991", "å°åŒ—å¸‚"),
    ("ä¿¡ç¾©å€", "25.0330,121.5654", "å°åŒ—å¸‚"),
    ("å£«æ—å€", "25.0877,121.5258", "å°åŒ—å¸‚"),
    ("åŒ—æŠ•å€", "25.1315,121.5017", "å°åŒ—å¸‚"),
    ("å…§æ¹–å€", "25.0692,121.5897", "å°åŒ—å¸‚"),
    ("å—æ¸¯å€", "25.0478,121.6073", "å°åŒ—å¸‚"),
    ("æ–‡å±±å€", "24.9876,121.5707", "å°åŒ—å¸‚"),

    # æ–°åŒ—å¸‚ (29å€)
    ("æ¿æ©‹å€", "25.0118,121.4625", "æ–°åŒ—å¸‚"),
    ("ä¸‰é‡å€", "25.0622,121.4848", "æ–°åŒ—å¸‚"),
    ("ä¸­å’Œå€", "24.9998,121.4991", "æ–°åŒ—å¸‚"),
    ("æ°¸å’Œå€", "25.0068,121.5161", "æ–°åŒ—å¸‚"),
    ("æ–°èŠå€", "25.0372,121.4325", "æ–°åŒ—å¸‚"),
    ("æ–°åº—å€", "24.9669,121.5414", "æ–°åŒ—å¸‚"),
    ("æ¨¹æ—å€", "24.9937,121.4200", "æ–°åŒ—å¸‚"),
    ("é¶¯æ­Œå€", "24.9542,121.3548", "æ–°åŒ—å¸‚"),
    ("ä¸‰å³½å€", "24.9342,121.3688", "æ–°åŒ—å¸‚"),
    ("æ·¡æ°´å€", "25.1645,121.4404", "æ–°åŒ—å¸‚"),
    ("æ±æ­¢å€", "25.0672,121.6422", "æ–°åŒ—å¸‚"),
    ("ç‘èŠ³å€", "25.1090,121.8070", "æ–°åŒ—å¸‚"),
    ("åœŸåŸå€", "24.9729,121.4419", "æ–°åŒ—å¸‚"),
    ("è˜†æ´²å€", "25.0840,121.4741", "æ–°åŒ—å¸‚"),
    ("äº”è‚¡å€", "25.0830,121.4439", "æ–°åŒ—å¸‚"),
    ("æ³°å±±å€", "25.0594,121.4218", "æ–°åŒ—å¸‚"),
    ("æ—å£å€", "25.0769,121.3895", "æ–°åŒ—å¸‚"),
    ("æ·±å‘å€", "24.9988,121.6161", "æ–°åŒ—å¸‚"),
    ("çŸ³ç¢‡å€", "24.9895,121.6635", "æ–°åŒ—å¸‚"),
    ("åªæ—å€", "24.9361,121.7098", "æ–°åŒ—å¸‚"),
    ("ä¸‰èŠå€", "25.2519,121.4990", "æ–°åŒ—å¸‚"),
    ("çŸ³é–€å€", "25.2915,121.5675", "æ–°åŒ—å¸‚"),
    ("å…«é‡Œå€", "25.1496,121.3996", "æ–°åŒ—å¸‚"),
    ("å¹³æºªå€", "25.0255,121.7417", "æ–°åŒ—å¸‚"),
    ("é›™æºªå€", "25.0336,121.8264", "æ–°åŒ—å¸‚"),
    ("è²¢å¯®å€", "25.0196,121.9085", "æ–°åŒ—å¸‚"),
    ("é‡‘å±±å€", "25.2225,121.6341", "æ–°åŒ—å¸‚"),
    ("è¬é‡Œå€", "25.1797,121.6897", "æ–°åŒ—å¸‚"),
    ("çƒä¾†å€", "24.8658,121.5497", "æ–°åŒ—å¸‚"),

    # æ¡ƒåœ’å¸‚ (13å€)
    ("æ¡ƒåœ’å€", "24.9936,121.3010", "æ¡ƒåœ’å¸‚"),
    ("ä¸­å£¢å€", "24.9537,121.2257", "æ¡ƒåœ’å¸‚"),
    ("å¤§æºªå€", "24.8838,121.2677", "æ¡ƒåœ’å¸‚"),
    ("æ¥Šæ¢…å€", "24.9175,121.1459", "æ¡ƒåœ’å¸‚"),
    ("è˜†ç«¹å€", "25.0441,121.2914", "æ¡ƒåœ’å¸‚"),
    ("å¤§åœ’å€", "25.0569,121.2014", "æ¡ƒåœ’å¸‚"),
    ("é¾œå±±å€", "25.0002,121.3539", "æ¡ƒåœ’å¸‚"),
    ("å…«å¾·å€", "24.9444,121.2999", "æ¡ƒåœ’å¸‚"),
    ("é¾æ½­å€", "24.8632,121.2167", "æ¡ƒåœ’å¸‚"),
    ("å¹³é®å€", "24.9234,121.2043", "æ¡ƒåœ’å¸‚"),
    ("æ–°å±‹å€", "24.9706,121.1061", "æ¡ƒåœ’å¸‚"),
    ("è§€éŸ³å€", "25.0357,121.1220", "æ¡ƒåœ’å¸‚"),
    ("å¾©èˆˆå€", "24.8176,121.3496", "æ¡ƒåœ’å¸‚"),

    # å°ä¸­å¸‚ (29å€)
    ("ä¸­å€", "24.1443,120.6794", "å°ä¸­å¸‚"),
    ("æ±å€", "24.1369,120.6973", "å°ä¸­å¸‚"),
    ("å—å€", "24.1201,120.6642", "å°ä¸­å¸‚"),
    ("è¥¿å€", "24.1393,120.6736", "å°ä¸­å¸‚"),
    ("åŒ—å€", "24.1548,120.6848", "å°ä¸­å¸‚"),
    ("è¥¿å±¯å€", "24.1618,120.6176", "å°ä¸­å¸‚"),
    ("å—å±¯å€", "24.1285,120.6185", "å°ä¸­å¸‚"),
    ("åŒ—å±¯å€", "24.1810,120.7131", "å°ä¸­å¸‚"),
    ("è±åŸå€", "24.2567,120.7236", "å°ä¸­å¸‚"),
    ("æ±å‹¢å€", "24.2610,120.8239", "å°ä¸­å¸‚"),
    ("å¤§ç”²å€", "24.3480,120.6242", "å°ä¸­å¸‚"),
    ("æ¸…æ°´å€", "24.2638,120.5685", "å°ä¸­å¸‚"),
    ("æ²™é¹¿å€", "24.2260,120.5687", "å°ä¸­å¸‚"),
    ("æ¢§æ£²å€", "24.2552,120.5216", "å°ä¸­å¸‚"),
    ("åé‡Œå€", "24.3047,120.7063", "å°ä¸­å¸‚"),
    ("ç¥å²¡å€", "24.2544,120.6647", "å°ä¸­å¸‚"),
    ("æ½­å­å€", "24.2067,120.7057", "å°ä¸­å¸‚"),
    ("å¤§é›…å€", "24.2286,120.6520", "å°ä¸­å¸‚"),
    ("æ–°ç¤¾å€", "24.2265,120.8069", "å°ä¸­å¸‚"),
    ("çŸ³å²¡å€", "24.2725,120.7827", "å°ä¸­å¸‚"),
    ("å¤–åŸ”å€", "24.3395,120.6519", "å°ä¸­å¸‚"),
    ("å¤§å®‰å€", "24.3452,120.5992", "å°ä¸­å¸‚"),
    ("çƒæ—¥å€", "24.1062,120.6238", "å°ä¸­å¸‚"),
    ("å¤§è‚šå€", "24.1566,120.5416", "å°ä¸­å¸‚"),
    ("é¾äº•å€", "24.1926,120.5435", "å°ä¸­å¸‚"),
    ("éœ§å³°å€", "24.0669,120.6998", "å°ä¸­å¸‚"),
    ("å¤ªå¹³å€", "24.1241,120.7339", "å°ä¸­å¸‚"),
    ("å¤§é‡Œå€", "24.0992,120.6773", "å°ä¸­å¸‚"),
    ("å’Œå¹³å€", "24.2395,121.0114", "å°ä¸­å¸‚"),

    # å°å—å¸‚ (37å€)
    ("ä¸­è¥¿å€", "22.9912,120.2020", "å°å—å¸‚"),
    ("æ±å€", "22.9837,120.2265", "å°å—å¸‚"),
    ("å—å€", "22.9735,120.1873", "å°å—å¸‚"),
    ("åŒ—å€", "23.0063,120.2121", "å°å—å¸‚"),
    ("å®‰å¹³å€", "23.0011,120.1662", "å°å—å¸‚"),
    ("å®‰å—å€", "23.0465,120.1864", "å°å—å¸‚"),
    ("æ°¸åº·å€", "23.0262,120.2571", "å°å—å¸‚"),
    ("æ­¸ä»å€", "22.9661,120.2896", "å°å—å¸‚"),
    ("æ–°åŒ–å€", "23.0379,120.3117", "å°å—å¸‚"),
    ("å·¦é®å€", "23.0537,120.4070", "å°å—å¸‚"),
    ("ç‰äº•å€", "23.1244,120.4601", "å°å—å¸‚"),
    ("æ¥ è¥¿å€", "23.1708,120.4856", "å°å—å¸‚"),
    ("å—åŒ–å€", "23.0421,120.4769", "å°å—å¸‚"),
    ("ä»å¾·å€", "22.9619,120.2477", "å°å—å¸‚"),
    ("é—œå»Ÿå€", "22.9704,120.3304", "å°å—å¸‚"),
    ("é¾å´å€", "22.9682,120.3567", "å°å—å¸‚"),
    ("å®˜ç”°å€", "23.1939,120.3860", "å°å—å¸‚"),
    ("éº»è±†å€", "23.1804,120.2473", "å°å—å¸‚"),
    ("ä½³é‡Œå€", "23.1646,120.1751", "å°å—å¸‚"),
    ("è¥¿æ¸¯å€", "23.1252,120.2038", "å°å—å¸‚"),
    ("ä¸ƒè‚¡å€", "23.1415,120.0881", "å°å—å¸‚"),
    ("å°‡è»å€", "23.2005,120.1695", "å°å—å¸‚"),
    ("å­¸ç”²å€", "23.2308,120.1761", "å°å—å¸‚"),
    ("åŒ—é–€å€", "23.2678,120.1248", "å°å—å¸‚"),
    ("æ–°ç‡Ÿå€", "23.3058,120.3169", "å°å—å¸‚"),
    ("å¾Œå£å€", "23.3665,120.3611", "å°å—å¸‚"),
    ("ç™½æ²³å€", "23.3516,120.4090", "å°å—å¸‚"),
    ("æ±å±±å€", "23.3279,120.3979", "å°å—å¸‚"),
    ("å…­ç”²å€", "23.2315,120.3477", "å°å—å¸‚"),
    ("ä¸‹ç‡Ÿå€", "23.2360,120.2639", "å°å—å¸‚"),
    ("æŸ³ç‡Ÿå€", "23.2776,120.3061", "å°å—å¸‚"),
    ("é¹½æ°´å€", "23.3196,120.2662", "å°å—å¸‚"),
    ("å–„åŒ–å€", "23.1322,120.2969", "å°å—å¸‚"),
    ("å¤§å…§å€", "23.1178,120.3520", "å°å—å¸‚"),
    ("å±±ä¸Šå€", "23.1049,120.3738", "å°å—å¸‚"),
    ("æ–°å¸‚å€", "23.0784,120.2951", "å°å—å¸‚"),
    ("å®‰å®šå€", "23.1215,120.2270", "å°å—å¸‚"),

    # é«˜é›„å¸‚ (38å€)
    ("é¼“å±±å€", "22.6515,120.2844", "é«˜é›„å¸‚"),
    ("å·¦ç‡Ÿå€", "22.6873,120.3066", "é«˜é›„å¸‚"),
    ("ä¸‰æ°‘å€", "22.6466,120.3265", "é«˜é›„å¸‚"),
    ("é³³å±±å€", "22.6287,120.3583", "é«˜é›„å¸‚"),
    ("è‹“é›…å€", "22.6239,120.3090", "é«˜é›„å¸‚"),
    ("æ–°èˆˆå€", "22.6317,120.3021", "é«˜é›„å¸‚"),
    ("å‰é‡‘å€", "22.6263,120.2956", "é«˜é›„å¸‚"),
    ("å‰é®å€", "22.5918,120.3083", "é«˜é›„å¸‚"),
    ("é¹½åŸ•å€", "22.6242,120.2842", "é«˜é›„å¸‚"),
    ("æ——æ´¥å€", "22.5884,120.2672", "é«˜é›„å¸‚"),
    ("å°æ¸¯å€", "22.5653,120.3452", "é«˜é›„å¸‚"),
    ("æ¥ æ¢“å€", "22.7283,120.3182", "é«˜é›„å¸‚"),
    ("ä»æ­¦å€", "22.7012,120.3603", "é«˜é›„å¸‚"),
    ("å¤§ç¤¾å€", "22.7325,120.3506", "é«˜é›„å¸‚"),
    ("é³¥æ¾å€", "22.6484,120.3629", "é«˜é›„å¸‚"),
    ("å¤§å¯®å€", "22.6057,120.3958", "é«˜é›„å¸‚"),
    ("æ—åœ’å€", "22.5006,120.3975", "é«˜é›„å¸‚"),
    ("å¤§æ¨¹å€", "22.6671,120.4344", "é«˜é›„å¸‚"),
    ("é˜¿è“®å€", "22.8844,120.3224", "é«˜é›„å¸‚"),
    ("è·¯ç«¹å€", "22.8562,120.2603", "é«˜é›„å¸‚"),
    ("æ¹–å…§å€", "22.8993,120.2457", "é«˜é›„å¸‚"),
    ("èŒ„è£å€", "22.8971,120.1804", "é«˜é›„å¸‚"),
    ("æ°¸å®‰å€", "22.8337,120.2172", "é«˜é›„å¸‚"),
    ("å²¡å±±å€", "22.7924,120.2982", "é«˜é›„å¸‚"),
    ("å½Œé™€å€", "22.7896,120.2456", "é«˜é›„å¸‚"),
    ("æ¢“å®˜å€", "22.7511,120.2605", "é«˜é›„å¸‚"),
    ("ç‡•å·¢å€", "22.7931,120.3622", "é«˜é›„å¸‚"),
    ("ç”°å¯®å€", "22.8773,120.3869", "é«˜é›„å¸‚"),
    ("æ——å±±å€", "22.8882,120.4812", "é«˜é›„å¸‚"),
    ("ç¾æ¿ƒå€", "22.9028,120.5598", "é«˜é›„å¸‚"),
    ("æ‰æ—å€", "22.9956,120.5481", "é«˜é›„å¸‚"),
    ("å…§é–€å€", "22.9537,120.4706", "é«˜é›„å¸‚"),
    ("å…­é¾œå€", "23.0182,120.6866", "é«˜é›„å¸‚"),
    ("ç”²ä»™å€", "23.0832,120.5914", "é«˜é›„å¸‚"),
    ("æ¡ƒæºå€", "23.2348,120.7437", "é«˜é›„å¸‚"),
    ("é‚£ç‘ªå¤å€", "23.2396,120.6825", "é«˜é›„å¸‚"),
    ("èŒ‚æ—å€", "22.8937,120.6592", "é«˜é›„å¸‚"),
    ("æ©‹é ­å€", "22.7568,120.3068", "é«˜é›„å¸‚"),

    # å±æ±ç¸£ (33é„‰é®å¸‚)
    ("å±æ±å¸‚", "22.6690,120.4883", "å±æ±ç¸£"),
    ("æ½®å·é®", "22.5508,120.5446", "å±æ±ç¸£"),
    ("æ±æ¸¯é®", "22.4658,120.4476", "å±æ±ç¸£"),
    ("æ†æ˜¥é®", "22.0018,120.7395", "å±æ±ç¸£"),
    ("è¬ä¸¹é„‰", "22.5892,120.4827", "å±æ±ç¸£"),
    ("é•·æ²»é„‰", "22.6779,120.5337", "å±æ±ç¸£"),
    ("éºŸæ´›é„‰", "22.6515,120.5244", "å±æ±ç¸£"),
    ("ä¹å¦‚é„‰", "22.7395,120.4823", "å±æ±ç¸£"),
    ("é‡Œæ¸¯é„‰", "22.7758,120.4999", "å±æ±ç¸£"),
    ("é¹½åŸ”é„‰", "22.7542,120.5527", "å±æ±ç¸£"),
    ("é«˜æ¨¹é„‰", "22.8058,120.6081", "å±æ±ç¸£"),
    ("è¬å·’é„‰", "22.5715,120.5907", "å±æ±ç¸£"),
    ("å…§åŸ”é„‰", "22.6110,120.5655", "å±æ±ç¸£"),
    ("ç«¹ç”°é„‰", "22.5839,120.5426", "å±æ±ç¸£"),
    ("æ–°åŸ¤é„‰", "22.4687,120.5566", "å±æ±ç¸£"),
    ("æ‹å¯®é„‰", "22.3618,120.5908", "å±æ±ç¸£"),
    ("æ–°åœ’é„‰", "22.4542,120.4582", "å±æ±ç¸£"),
    ("å´é ‚é„‰", "22.5066,120.5034", "å±æ±ç¸£"),
    ("æ—é‚Šé„‰", "22.4287,120.5116", "å±æ±ç¸£"),
    ("å—å·é„‰", "22.4900,120.5143", "å±æ±ç¸£"),
    ("ä½³å†¬é„‰", "22.4272,120.5553", "å±æ±ç¸£"),
    ("ç‰çƒé„‰", "22.3444,120.3714", "å±æ±ç¸£"),
    ("è»ŠåŸé„‰", "22.0742,120.7090", "å±æ±ç¸£"),
    ("æ»¿å·é„‰", "22.0288,120.7842", "å±æ±ç¸£"),
    ("æ‹å±±é„‰", "22.2630,120.6552", "å±æ±ç¸£"),
    ("ä¸‰åœ°é–€é„‰", "22.7179,120.6548", "å±æ±ç¸£"),
    ("éœ§å°é„‰", "22.7542,120.7394", "å±æ±ç¸£"),
    ("ç‘ªå®¶é„‰", "22.6818,120.6737", "å±æ±ç¸£"),
    ("æ³°æ­¦é„‰", "22.6081,120.6515", "å±æ±ç¸£"),
    ("ä¾†ç¾©é„‰", "22.5284,120.6648", "å±æ±ç¸£"),
    ("æ˜¥æ—¥é„‰", "22.3966,120.6182", "å±æ±ç¸£"),
    ("ç…å­é„‰", "22.2284,120.7208", "å±æ±ç¸£"),
    ("ç‰¡ä¸¹é„‰", "22.1351,120.7834", "å±æ±ç¸£")
]

# âœ… 3. æå–LINEè¯çµ¡æ–¹å¼çš„å‡½æ•¸
def extract_line_contact(text):
    """å¾æ–‡å­—ä¸­æå–LINEè¯çµ¡æ–¹å¼"""
    if not text:
        return 'N/A'
    
    # å¸¸è¦‹çš„LINE IDæ ¼å¼
    line_patterns = [
        r'line[ï¼š:]\s*@?([a-zA-Z0-9_.-]+)',
        r'line\s*id[ï¼š:]\s*@?([a-zA-Z0-9_.-]+)',
        r'@([a-zA-Z0-9_.-]+)',
        r'line[ï¼š:]\s*([a-zA-Z0-9_.-]+)',
        r'åŠ line[ï¼š:]\s*@?([a-zA-Z0-9_.-]+)',
        r'åŠ å…¥line[ï¼š:]\s*@?([a-zA-Z0-9_.-]+)'
    ]
    
    text_lower = text.lower()
    for pattern in line_patterns:
        match = re.search(pattern, text_lower, re.IGNORECASE)
        if match:
            line_id = match.group(1)
            return f"@{line_id}" if not line_id.startswith('@') else line_id
    
    return 'N/A'

# âœ… 4. æœå°‹é™„è¿‘åº—å®¶ï¼ˆæœ€å¤š 60 ç­†ï¼‰ - NearbySearch
def search_places_nearby(keyword, location, radius):
    url = 'https://maps.googleapis.com/maps/api/place/nearbysearch/json'
    params = {
        'key': API_KEY,
        'location': location,
        'radius': radius,
        'keyword': keyword,
        'language': 'zh-TW'
    }

    results = []
    while True:
        res = requests.get(url, params=params).json()
        results.extend(res.get('results', []))

        next_page_token = res.get('next_page_token')
        if next_page_token:
            time.sleep(2)
            params['pagetoken'] = next_page_token
        else:
            break
    return results

# âœ… 4.1. æ–‡å­—æœå°‹ï¼ˆæ›´å»£æ³›çš„æœå°‹ï¼‰
def search_places_text(keyword, location, radius):
    url = 'https://maps.googleapis.com/maps/api/place/textsearch/json'
    params = {
        'key': API_KEY,
        'query': f"{keyword} {location}",
        'radius': radius,
        'language': 'zh-TW'
    }

    results = []
    while True:
        res = requests.get(url, params=params).json()
        results.extend(res.get('results', []))

        next_page_token = res.get('next_page_token')
        if next_page_token:
            time.sleep(2)
            params['pagetoken'] = next_page_token
        else:
            break
    return results

# âœ… 4.2. å¤šé—œéµå­—æœå°‹ç­–ç•¥
def search_places_comprehensive(keywords, location, radius):
    """ç¶œåˆæœå°‹ç­–ç•¥ï¼šä½¿ç”¨å¤šå€‹é—œéµå­—å’Œæœå°‹æ–¹æ³•"""
    all_results = []
    
    for keyword in keywords:
        print(f"   ğŸ” æœå°‹é—œéµå­—ï¼š{keyword}")
        
        # æ–¹æ³•1: NearbySearch
        nearby_results = search_places_nearby(keyword, location, radius)
        all_results.extend(nearby_results)
        time.sleep(1)
        
        # æ–¹æ³•2: TextSearch (æ›´å»£æ³›)
        text_results = search_places_text(keyword, location, radius)
        all_results.extend(text_results)
        time.sleep(1)
        
        # æ–¹æ³•3: åŠ ä¸Šé¡åˆ¥æœå°‹
        category_results = search_places_nearby(f"{keyword} ç¾å®¹", location, radius)
        all_results.extend(category_results)
        time.sleep(1)
    
    return all_results

# âœ… 5. å–å¾—åº—å®¶è©³ç´°è³‡è¨Šï¼ˆå«é›»è©±ã€ç¶²ç«™ã€è©•è«–ç­‰ï¼‰
def get_place_details(place_id):
    url = 'https://maps.googleapis.com/maps/api/place/details/json'
    params = {
        'key': API_KEY,
        'place_id': place_id,
        'language': 'zh-TW',
        'fields': 'name,formatted_address,formatted_phone_number,website,reviews,editorial_summary'
    }
    res = requests.get(url, params=params).json()
    return res.get('result', {})

# âœ… 6. å»é‡è¤‡åŠŸèƒ½
def deduplicate_places(places):
    """æ ¹æ“š place_id å»é™¤é‡è¤‡åº—å®¶"""
    seen_ids = set()
    unique_places = []
    
    for place in places:
        place_id = place.get('place_id')
        if place_id and place_id not in seen_ids:
            seen_ids.add(place_id)
            unique_places.append(place)
    
    return unique_places

# âœ… 7. ä¸»ç¨‹å¼ï¼šéæ­·æ‰€æœ‰å€åŸŸä¸¦è¼¸å‡ºåº—å®¶è³‡è¨Š
def run_search_all_areas(keywords=None, radius=8000):
    if keywords is None:
        # æ“´å……é—œéµå­—åˆ—è¡¨ï¼ŒåŒ…å«ç›¸é—œè®Šå½¢è©
        keywords = [
            "ç¾ç”²", "æŒ‡ç”²å½©ç¹ª", "å‡è† æŒ‡ç”²", "å…‰ç™‚ç¾ç”²",
            "ç¾ç«", "ç«æ¯›å«æ¥", "æ¥ç«æ¯›", "ç«æ¯›ç¾å®¹",
            "è€³ç‡­", "è€³ç‡­ç™‚æ³•", "è€³æœµSPA",
            "æ¡è€³", "æ¸…è€³å¢", "è€³æœµæ¸…æ½”", "æè€³æœµ",
            "ç†±è Ÿ", "ç†±è Ÿé™¤æ¯›", "èœœè Ÿé™¤æ¯›"
        ]
    all_results = []
    total_areas = len(area_keywords)
    
    print(f"ğŸ¯ æœå°‹é—œéµå­—ï¼š{', '.join(keywords)}")
    print(f"ğŸ“ æœå°‹åŠå¾‘ï¼š{radius} å…¬å°º")
    
    for index, (area_name, center, city) in enumerate(area_keywords, 1):
        print(f"ğŸ” æœå°‹å€åŸŸï¼š{city} {area_name} ({index}/{total_areas})")
        
        # ä½¿ç”¨ç¶œåˆæœå°‹ç­–ç•¥
        places = search_places_comprehensive(keywords, center, radius)
        
        # å»é™¤é‡è¤‡
        unique_places = deduplicate_places(places)
        print(f"æ‰¾åˆ° {len(places)} é–“åº—å®¶ï¼Œå»é‡å¾Œ {len(unique_places)} é–“")

        for place in unique_places:
            try:
                name = place.get('name')
                address = place.get('vicinity')
                place_id = place.get('place_id')
                
                # å–å¾—è©³ç´°è³‡è¨Š
                details = get_place_details(place_id)
                phone = details.get('formatted_phone_number', 'N/A')
                website = details.get('website', '')
                
                # ä¿®æ­£Google Mapsé€£çµæ ¼å¼
                maps_url = f"https://www.google.com/maps/place/?q=place_id:{place_id}"
                
                # æœå°‹LINEè¯çµ¡æ–¹å¼
                line_contact = 'N/A'
                
                # å¾ç¶²ç«™é€£çµæŸ¥æ‰¾LINE
                if website and 'line' in website.lower():
                    line_contact = extract_line_contact(website)
                
                # å¾è©•è«–ä¸­æœå°‹LINEè³‡è¨Š
                if line_contact == 'N/A' and details.get('reviews'):
                    for review in details.get('reviews', [])[:5]:  # åªæª¢æŸ¥å‰5å€‹è©•è«–
                        review_text = review.get('text', '')
                        extracted_line = extract_line_contact(review_text)
                        if extracted_line != 'N/A':
                            line_contact = extracted_line
                            break
                
                # å¾ç·¨è¼¯æ‘˜è¦æœå°‹LINEè³‡è¨Š
                if line_contact == 'N/A' and details.get('editorial_summary'):
                    summary_text = details.get('editorial_summary', {}).get('overview', '')
                    line_contact = extract_line_contact(summary_text)

                result = {
                    'ç¸£å¸‚': city,
                    'å€åŸŸ': area_name,
                    'åº—å': name,
                    'åœ°å€': address,
                    'é›»è©±': phone,
                    'LINEè¯çµ¡æ–¹å¼': line_contact,
                    'ç¶²ç«™': website if website else 'N/A',
                    'åœ°åœ–é€£çµ': maps_url
                }
                all_results.append(result)

                print(f"âœ… {name}")
                print(f"åœ°å€ï¼š{address}")
                print(f"é›»è©±ï¼š{phone}")
                print(f"LINEï¼š{line_contact}")
                print(f"ç¶²ç«™ï¼š{website if website else 'N/A'}")
                print(f"åœ°åœ–ï¼š{maps_url}")
                print("---")
                
                time.sleep(1)
            except Exception as e:
                print(f"âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
                continue

    # æœ€çµ‚å…¨åŸŸå»é‡
    print("\nğŸ”„ é€²è¡Œæœ€çµ‚å»é‡è™•ç†...")
    final_results = []
    seen_places = set()
    
    for result in all_results:
        # ä½¿ç”¨åº—å+åœ°å€ä½œç‚ºè­˜åˆ¥
        identifier = f"{result['åº—å']}_{result['åœ°å€']}"
        if identifier not in seen_places:
            seen_places.add(identifier)
            final_results.append(result)
    
    removed_count = len(all_results) - len(final_results)
    print(f"âœ… å»é™¤ {removed_count} ç­†é‡è¤‡è³‡æ–™")
    print(f"ğŸ‰ æœ€çµ‚å®Œæˆï¼Œå…± {len(final_results)} ç­†åº—å®¶è³‡æ–™")
    
    return final_results

# âœ… 8. å°‡çµæœå¯«å…¥ CSV æª”æ¡ˆ
def save_to_csv(data, filename="taiwan_six_cities_beauty_shops.csv"):
    with open(filename, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.DictWriter(f, fieldnames=['ç¸£å¸‚', 'å€åŸŸ', 'åº—å', 'åœ°å€', 'é›»è©±', 'LINEè¯çµ¡æ–¹å¼', 'ç¶²ç«™', 'åœ°åœ–é€£çµ'])
        writer.writeheader()
        writer.writerows(data)
    print(f"\nğŸ“ æˆåŠŸè¼¸å‡ºè‡³ CSV æª”æ¡ˆï¼š{filename}")

# âœ… 9. åŸ·è¡Œä¸»æµç¨‹
if __name__ == '__main__':
    print("ğŸš€ é–‹å§‹æœå°‹å°ç£å…­éƒ½ + å±æ±çš„ç¾å®¹åº—å®¶è³‡æ–™...")
    print("ğŸ’… æœå°‹é¡å‹ï¼šç¾ç”²ã€ç¾ç«ã€è€³ç‡­ã€æ¡è€³ã€ç†±è Ÿ")
    print("ğŸ“ æ¶µè“‹å€åŸŸï¼šå°åŒ—å¸‚ã€æ–°åŒ—å¸‚ã€æ¡ƒåœ’å¸‚ã€å°ä¸­å¸‚ã€å°å—å¸‚ã€é«˜é›„å¸‚ã€å±æ±ç¸£")
    print(f"ğŸ“Š ç¸½å…± {len(area_keywords)} å€‹è¡Œæ”¿å€")
    print("ğŸ” æœå°‹ç­–ç•¥ï¼šå¤šé—œéµå­— + å¤šæ–¹æ³• + æ“´å¤§åŠå¾‘")
    print("=" * 60)
    
    data = run_search_all_areas()
    save_to_csv(data)
    
    # çµ±è¨ˆçµæœ
    if data:
        city_stats = {}
        for item in data:
            city = item['ç¸£å¸‚']
            city_stats[city] = city_stats.get(city, 0) + 1
        
        print("\nğŸ“ˆ å„ç¸£å¸‚åº—å®¶çµ±è¨ˆï¼š")
        for city, count in city_stats.items():
            print(f"   {city}ï¼š{count} é–“åº—å®¶")
